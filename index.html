<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BBRC Digital Auto-Aplicável</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body {
            background-color: #f1f5f9; /* slate-100 */
        }
        @media print {
            .no-print { display: none; }
            body { background-color: white; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;

        // --- ICONS (Substituindo lucide-react para rodar no navegador) ---
        const Icon = ({ children, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}>
                {children}
            </svg>
        );

        const Mic = (props) => <Icon {...props}><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></Icon>;
        const MicOff = (props) => <Icon {...props}><line x1="1" y1="1" x2="23" y2="23"/><path d="M9 9v3a3 3 0 0 0 5.12 2.12"/><line x1="15" y1="9.34" x2="15" y2="4a3 3 0 0 0-5.94-.6"/><path d="M17 16.95A7 7 0 0 1 5 12v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></Icon>;
        const Play = (props) => <Icon {...props}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const Save = (props) => <Icon {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></Icon>;
        const RotateCcw = (props) => <Icon {...props}><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></Icon>;
        const CheckCircle = (props) => <Icon {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></Icon>;
        const AlertCircle = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></Icon>;
        const Clock = (props) => <Icon {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Brain = (props) => <Icon {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></Icon>;
        const FileText = (props) => <Icon {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></Icon>;
        const ImageIcon = (props) => <Icon {...props}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></Icon>;


        // --- CONFIGURAÇÃO E DADOS ---

        const TARGET_WORDS = [
        "sapato", "casa", "pente", "chave", "avião",
        "balde", "tartaruga", "livro", "colher", "árvore",
        "arvore", "aviao" // Variações sem acento
        ];

        // Lista estendida para reconhecimento de animais (simplificada)
        const ANIMAL_KEYWORDS = [
        "cachorro", "gato", "cavalo", "vaca", "boi", "elefante", "leão", "tigre", "onça", "macaco",
        "girafa", "jacaré", "cobra", "pássaro", "galinha", "galo", "pato", "ganso", "rato", "camundongo",
        "coelho", "peixe", "baleia", "tubarão", "golfinho", "urso", "lobo", "raposa", "porco", "ovelha",
        "cabra", "bode", "zebra", "rinoceronte", "hipopótamo", "águia", "falcão", "papagaio", "arara",
        "tucano", "pinguim", "foca", "lontra", "tamanduá", "tatu", "capivara", "anta", "veado", "búfalo",
        "jumento", "burro", "mula", "égua", "cão", "felino", "ave", "inseto", "formiga", "abelha", "mosca"
        ];

        const PHASES = {
        WELCOME: 'welcome',
        NAMING: 'naming',           // Nomeação
        INCIDENTAL: 'incidental',   // Memória Incidental
        IMMEDIATE: 'immediate',     // Memória Imediata (30s exp) -> Evocação
        LEARNING: 'learning',       // Aprendizado (30s exp) -> Evocação
        FLUENCY: 'fluency',         // Fluência Verbal (Animais 1min)
        CLOCK: 'clock',             // Desenho do Relógio
        DELAYED: 'delayed',         // Memória Tardia
        RECOGNITION: 'recognition', // Reconhecimento
        REPORT: 'report'
        };

        const SHULMAN_CRITERIA = [
            { score: 5, label: "Relógio perfeito" },
            { score: 4, label: "Mínimo erro visuoespacial" },
            { score: 3, label: "Horário 11:10 inadequado, sem grande alteração visuoespacial" },
            { score: 2, label: "Erro visuoespacial moderado, impossibilitando indicação dos ponteiros" },
            { score: 1, label: "Grande desorganização visuoespacial" },
            { score: 0, label: "Incapacidade de representar qualquer imagem de relógio" }
        ];

        // --- COMPONENTES UTILITÁRIOS ---

        // Variável de módulo para evitar repetição de fala quando componentes remontam
        let lastSpokenText = '';

        const SpeechSynthesizer = ({ text, autoPlay = true }) => {
        useEffect(() => {
            if (autoPlay && text && text !== lastSpokenText) {
            lastSpokenText = text;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'pt-BR';
            utterance.rate = 1.0;
            window.speechSynthesis.cancel();
            window.speechSynthesis.speak(utterance);
            }
        }, [text, autoPlay]);

        return null;
        };

        // --- COMPONENTES DE FASE (fora do App para referência estável) ---

        const MemoryPhase = ({ title, instruction, showImage, duration = 0, autoAdvance = false, hideInput = false, allowInputWithImage = false, stimuliImage, isListening, transcript, toggleListening, onNextPhase }) => {
            const [timeLeft, setTimeLeft] = useState(duration);
            const [showStimulus, setShowStimulus] = useState(showImage);
            const canShowInput = !showStimulus || allowInputWithImage;

            useEffect(() => {
            if (duration > 0 && showStimulus) {
                const interval = setInterval(() => {
                setTimeLeft(t => {
                    if (t <= 1) {
                    clearInterval(interval);
                    setShowStimulus(false);
                    if (!autoAdvance) {
                        toggleListening(true);
                    }
                    return 0;
                    }
                    return t - 1;
                });
                }, 1000);
                return () => clearInterval(interval);
            } else if (!showImage) {
                toggleListening(true);
            } else if (allowInputWithImage) {
                toggleListening(true);
            }
            }, [duration, showStimulus, allowInputWithImage, showImage, toggleListening]);

            return (
            <div className="flex flex-col items-center space-y-6 text-center">
                <SpeechSynthesizer text={showStimulus ? instruction : "Quais figuras eu mostrei?"} />
                <h2 className="text-2xl font-bold text-gray-800">{title}</h2>

                {showStimulus ? (
                <div className="relative">
                    <img
                    src={stimuliImage}
                    onError={(e) => {
                        e.target.onerror = null;
                        e.target.parentElement.innerHTML = `<div class="p-8 border-2 border-red-300 bg-red-50 text-red-800 rounded">Erro: Imagem "bbrc_estimulos.jpg" não encontrada na pasta do site.</div>`;
                    }}
                    alt="Estímulos"
                    className="max-w-full h-auto max-h-[50vh] rounded shadow-md"
                    />
                    {duration > 0 && (
                    <div className="absolute top-2 right-2 bg-black/70 text-white px-3 py-1 rounded-full text-lg font-mono">
                        {timeLeft}s
                    </div>
                    )}
                </div>
                ) : (
                <div className="w-full h-64 bg-gray-100 rounded-lg flex items-center justify-center flex-col">
                    <Brain size={64} className="text-gray-400 mb-4" />
                    <p className="text-gray-500">Memória em teste...</p>
                </div>
                )}

                {canShowInput && !hideInput && (
                <div className="w-full max-w-lg">
                    <div className={`p-4 rounded-lg border-2 ${isListening ? 'border-red-500 bg-red-50' : 'border-gray-200'}`}>
                    <div className="flex justify-between items-center mb-2">
                        <span className="font-semibold text-gray-700">Sua resposta (fale agora):</span>
                        {isListening ? <Mic className="animate-pulse text-red-500" /> : <MicOff className="text-gray-400"/>}
                    </div>
                    <div className="min-h-[60px] text-left text-lg p-2 bg-white rounded border border-gray-100">
                        {transcript || "Ouvindo..."}
                    </div>
                    </div>
                    <p className="text-sm text-gray-500 mt-2">{allowInputWithImage ? "Diga o nome de cada figura em voz alta." : "Diga os nomes das figuras que você lembra."}</p>
                </div>
                )}

                {canShowInput && (
                    <button onClick={onNextPhase} className="px-8 py-3 bg-green-600 text-white rounded-lg font-bold text-lg hover:bg-green-700 shadow-lg flex items-center gap-2">
                    Próxima Etapa <Play size={20} fill="white" />
                    </button>
                )}
            </div>
            );
        };

        const FluencyPhase = ({ transcript, toggleListening, onNextPhase }) => {
            const [timeLeft, setTimeLeft] = useState(60);
            const [started, setStarted] = useState(false);

            const startTest = () => {
            setStarted(true);
            toggleListening(true);
            const interval = setInterval(() => {
                setTimeLeft(t => {
                if (t <= 1) {
                    clearInterval(interval);
                    toggleListening(false);
                    return 0;
                }
                return t - 1;
                });
            }, 1000);
            };

            return (
            <div className="flex flex-col items-center space-y-6 text-center">
                <SpeechSynthesizer text="Diga o maior número possível de nomes de animais. Comece agora." autoPlay={started} />
                <h2 className="text-2xl font-bold text-gray-800">Fluência Verbal</h2>

                {!started ? (
                <div className="text-center space-y-4">
                    <p className="text-lg">Você terá 1 minuto para dizer nomes de animais.</p>
                    <button onClick={startTest} className="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold text-lg">
                    Começar (1 minuto)
                    </button>
                </div>
                ) : (
                <>
                    <div className="text-6xl font-mono font-bold text-blue-600">{timeLeft}</div>
                    <div className="w-full max-w-lg p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[100px]">
                    <p className="text-gray-500 text-sm mb-2">Animais identificados:</p>
                    <p className="text-lg">{transcript}</p>
                    </div>
                    {timeLeft === 0 && (
                    <button onClick={onNextPhase} className="px-8 py-3 bg-green-600 text-white rounded-lg font-bold">
                        Continuar
                    </button>
                    )}
                </>
                )}
            </div>
            );
        };

        const ClockPhase = ({ onSetClockScore, onNextPhase }) => {
            const canvasRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [ctx, setCtx] = useState(null);
            const [selectedScore, setSelectedScore] = useState(null);
            const [showScoring, setShowScoring] = useState(false);

            useEffect(() => {
            const canvas = canvasRef.current;
            const context = canvas.getContext('2d');
            context.lineCap = 'round';
            context.lineJoin = 'round';
            context.lineWidth = 3;
            context.strokeStyle = 'black';
            setCtx(context);
            }, []);

            const startDraw = (e) => {
            const { offsetX, offsetY } = getCoordinates(e);
            ctx.beginPath();
            ctx.moveTo(offsetX, offsetY);
            setIsDrawing(true);
            };

            const draw = (e) => {
            if (!isDrawing) return;
            const { offsetX, offsetY } = getCoordinates(e);
            ctx.lineTo(offsetX, offsetY);
            ctx.stroke();
            };

            const stopDraw = () => {
            ctx.closePath();
            setIsDrawing(false);
            };

            const getCoordinates = (e) => {
            if (e.touches && e.touches[0]) {
                const rect = canvasRef.current.getBoundingClientRect();
                return {
                offsetX: e.touches[0].clientX - rect.left,
                offsetY: e.touches[0].clientY - rect.top
                };
            }
            return { offsetX: e.nativeEvent.offsetX, offsetY: e.nativeEvent.offsetY };
            };

            const clearCanvas = () => {
            ctx.clearRect(0, 0, canvasRef.current.width, canvasRef.current.height);
            };

            const finishDrawing = () => {
            setShowScoring(true);
            };

            const confirmScore = () => {
            if (selectedScore === null) return;
            onSetClockScore(selectedScore);
            onNextPhase();
            };

            return (
            <div className="flex flex-col items-center space-y-4">
                <SpeechSynthesizer text="Desenhe um relógio grande, coloque todos os números, e marque onze horas e dez minutos." />
                <h2 className="text-2xl font-bold text-gray-800">Teste do Relógio</h2>
                <p className="text-gray-600 text-center max-w-md">Desenhe o mostrador, os números e os ponteiros marcando <strong>11h10</strong>.</p>

                <canvas
                ref={canvasRef}
                width={300}
                height={300}
                className="bg-white border-2 border-gray-300 rounded shadow-inner touch-none cursor-crosshair"
                onMouseDown={startDraw}
                onMouseMove={draw}
                onMouseUp={stopDraw}
                onMouseLeave={stopDraw}
                onTouchStart={startDraw}
                onTouchMove={draw}
                onTouchEnd={stopDraw}
                />

                {!showScoring ? (
                <div className="flex gap-4">
                    <button onClick={clearCanvas} className="flex items-center gap-2 px-4 py-2 bg-gray-200 rounded text-gray-700 font-medium">
                    <RotateCcw size={18} /> Limpar
                    </button>
                    <button onClick={finishDrawing} className="flex items-center gap-2 px-6 py-2 bg-blue-600 rounded text-white font-bold">
                    <Save size={18} /> Finalizar Desenho
                    </button>
                </div>
                ) : (
                <div className="w-full max-w-lg bg-white p-4 rounded-lg border-2 border-blue-300 shadow">
                    <h3 className="font-bold text-gray-700 mb-3">Pontuação (Critérios de Shulman):</h3>
                    <div className="space-y-2">
                    {SHULMAN_CRITERIA.map(({ score, label }) => (
                        <label key={score} className={`flex items-center gap-3 p-2 rounded cursor-pointer border ${selectedScore === score ? 'bg-blue-100 border-blue-400' : 'border-gray-200 hover:bg-gray-50'}`}>
                        <input
                            type="radio"
                            name="clockScore"
                            value={score}
                            checked={selectedScore === score}
                            onChange={() => setSelectedScore(score)}
                            className="accent-blue-600"
                        />
                        <span className="font-mono font-bold w-6">{score}</span>
                        <span className="text-sm">{label}</span>
                        </label>
                    ))}
                    </div>
                    <button
                    onClick={confirmScore}
                    disabled={selectedScore === null}
                    className={`mt-4 w-full py-2 rounded font-bold text-white ${selectedScore !== null ? 'bg-green-600 hover:bg-green-700' : 'bg-gray-300 cursor-not-allowed'}`}
                    >
                    Confirmar e Avançar
                    </button>
                </div>
                )}
            </div>
            );
        };

        const RecognitionPhase = ({ recognitionImage, isListening, transcript, toggleListening, onNextPhase }) => {
            useEffect(() => {
                toggleListening(true);
            }, [toggleListening]);

            return (
            <div className="flex flex-col items-center space-y-6 text-center">
                <SpeechSynthesizer text="Olhe para estas figuras. Diga ou aponte quais delas faziam parte daquele primeiro grupo que eu lhe mostrei." />
                <h2 className="text-2xl font-bold text-gray-800">Reconhecimento</h2>

                <img
                    src={recognitionImage}
                    onError={(e) => {
                    e.target.onerror = null;
                    e.target.parentElement.innerHTML = `<div class="p-8 border-2 border-red-300 bg-red-50 text-red-800 rounded">Erro: Imagem "bbrc_reconhecimento.jpg" não encontrada na pasta do site.</div>`;
                    }}
                    alt="Reconhecimento"
                    className="max-w-full h-auto max-h-[50vh] rounded shadow-md"
                />

                <div className={`w-full max-w-lg p-4 rounded-lg border-2 ${isListening ? 'border-red-500 bg-red-50' : 'border-gray-200'}`}>
                    <div className="flex justify-between items-center mb-2">
                    <span className="font-semibold text-gray-700">Figuras identificadas:</span>
                    {isListening ? <Mic className="animate-pulse text-red-500" /> : <MicOff className="text-gray-400"/>}
                    </div>
                    <div className="min-h-[60px] text-left p-2 bg-white rounded border border-gray-100">
                    {transcript || "Ouvindo... (Diga o nome das figuras)"}
                    </div>
                </div>

                <button onClick={onNextPhase} className="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold">
                    Ver Resultados
                </button>
            </div>
            );
        };

        const ReportPhase = ({ scores, educationLevel, setEducationLevel }) => {
            const getFeedback = (score, cutoff) => {
            if (score <= cutoff) return <span className="text-red-600 font-bold flex items-center gap-1"><AlertCircle size={16}/> Atenção</span>;
            return <span className="text-green-600 font-bold flex items-center gap-1"><CheckCircle size={16}/> Normal</span>;
            };

            return (
            <div className="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg print:shadow-none">
                <div className="text-center mb-8">
                <h1 className="text-3xl font-bold text-blue-900 mb-2">Relatório BBRC Digital</h1>
                <p className="text-gray-500">Resultados da Auto-Aplicação</p>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Tabela de Memória */}
                <div className="bg-gray-50 p-4 rounded-lg">
                    <h3 className="font-bold text-gray-700 border-b pb-2 mb-3 flex items-center gap-2"><Brain size={18}/> Perfil de Memória</h3>
                    <ul className="space-y-3 text-sm">
                    <li className="flex justify-between items-center">
                        <span>Nomeação:</span>
                        <span className="font-mono font-bold">{scores.naming}/10</span>
                    </li>
                    <li className="flex justify-between items-center">
                        <span>Incidental (Corte ≤4):</span>
                        <div className="flex items-center gap-2">
                        <span className="font-mono font-bold">{scores.incidental}/10</span>
                        {getFeedback(scores.incidental, 4)}
                        </div>
                    </li>
                    <li className="flex justify-between items-center">
                        <span>Imediata (Corte ≤6):</span>
                        <div className="flex items-center gap-2">
                        <span className="font-mono font-bold">{scores.immediate}/10</span>
                        {getFeedback(scores.immediate, 6)}
                        </div>
                    </li>
                    <li className="flex justify-between items-center">
                        <span>Aprendizado (Corte ≤6):</span>
                        <div className="flex items-center gap-2">
                        <span className="font-mono font-bold">{scores.learning}/10</span>
                        {getFeedback(scores.learning, 6)}
                        </div>
                    </li>
                    <li className="flex justify-between items-center bg-blue-100 p-2 rounded -mx-2">
                        <span className="font-bold text-blue-900">Memória Tardia (Corte ≤5):</span>
                        <div className="flex items-center gap-2">
                        <span className="font-mono font-bold text-lg">{scores.delayed}/10</span>
                        {getFeedback(scores.delayed, 5)}
                        </div>
                    </li>
                    <li className="flex justify-between items-center">
                        <span>Reconhecimento (Corte ≤7):</span>
                        <div className="flex items-center gap-2">
                        <span className="font-mono font-bold">{scores.recognition}/10</span>
                        {getFeedback(scores.recognition, 7)}
                        </div>
                    </li>
                    </ul>
                </div>

                {/* Funções Executivas */}
                <div className="bg-gray-50 p-4 rounded-lg">
                    <h3 className="font-bold text-gray-700 border-b pb-2 mb-3 flex items-center gap-2"><Clock size={18}/> Funções Executivas</h3>

                    <div className="mb-4">
                        <label className="block text-sm font-semibold text-gray-600 mb-1">Escolaridade do paciente:</label>
                        <select
                            value={educationLevel}
                            onChange={(e) => setEducationLevel(Number(e.target.value))}
                            className="w-full p-2 border border-gray-300 rounded text-sm"
                        >
                            <option value={0}>Analfabeto</option>
                            <option value={1}>1–7 anos de escolaridade</option>
                            <option value={2}>8+ anos de escolaridade</option>
                        </select>
                    </div>

                    <ul className="space-y-4 text-sm">
                    <li>
                        <div className="flex justify-between items-center mb-1">
                        <span>Fluência Verbal (Animais):</span>
                        <div className="flex items-center gap-2">
                            <span className="font-mono font-bold text-lg">{scores.fluency}</span>
                            {getFeedback(scores.fluency, educationLevel === 0 ? 8 : educationLevel === 1 ? 11 : 12)}
                        </div>
                        </div>
                        <p className="text-xs text-gray-500">
                            Corte: ≤8 (Analfabetos), ≤11 (1-7 anos), ≤12 (8+ anos)
                        </p>
                    </li>
                    <li>
                        <div className="flex justify-between items-center mb-1">
                        <span>Desenho do Relógio (Shulman):</span>
                        <span className="font-mono font-bold text-lg">{scores.clock}/5</span>
                        </div>
                        <p className="text-xs text-gray-500">Pontuação conforme critérios de Shulman (0-5).</p>
                    </li>
                    </ul>
                </div>
                </div>

                <div className="mt-8 p-4 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">
                <strong>Nota Importante:</strong> Este é um instrumento de rastreio digital. Os resultados podem ser influenciados pela qualidade do microfone, ruído ambiente ou familiaridade com tecnologia. Um resultado abaixo do ponto de corte sugere a necessidade de avaliação formal com um profissional de saúde, mas não confirma diagnóstico de demência.
                </div>

                <button onClick={() => window.print()} className="mt-6 w-full py-3 border-2 border-blue-600 text-blue-600 font-bold rounded hover:bg-blue-50 flex items-center justify-center gap-2">
                <FileText size={20}/> Imprimir / Salvar PDF
                </button>
            </div>
            );
        };

        // --- COMPONENTE PRINCIPAL ---

        function App() {
        const [currentPhase, setCurrentPhase] = useState(PHASES.WELCOME);

        const [images] = useState({
            stimuli: './bbrc_estimulos.jpg',
            recognition: './bbrc_reconhecimento.jpg'
        });

        const [transcript, setTranscript] = useState("");
        const [isListening, setIsListening] = useState(false);
        const [scores, setScores] = useState({
            naming: 0,
            incidental: 0,
            immediate: 0,
            learning: 0,
            fluency: 0,
            clock: 0,
            delayed: 0,
            recognition: 0
        });
        const [educationLevel, setEducationLevel] = useState(2);

        const recognitionRef = useRef(null);
        const isListeningRef = useRef(false);

        // --- LÓGICA DE RECONHECIMENTO DE VOZ ---

        useEffect(() => {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognitionRef.current = new SpeechRecognition();
            recognitionRef.current.continuous = true;
            recognitionRef.current.interimResults = true;
            recognitionRef.current.lang = 'pt-BR';

            recognitionRef.current.onresult = (event) => {
                let finalTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript + ' ';
                }
                }
                if (finalTranscript) {
                setTranscript(prev => (prev + " " + finalTranscript).trim());
                }
            };

            recognitionRef.current.onerror = (event) => {
                console.error("Erro no reconhecimento de voz:", event.error);
                setIsListening(false);
                isListeningRef.current = false;
            };

            recognitionRef.current.onend = () => {
                // Reiniciar se deveria estar ouvindo (para contornar paradas automáticas)
                if (isListeningRef.current) {
                    try { recognitionRef.current.start(); } catch(e) {}
                }
            };
            } else {
            alert("Seu navegador não suporta reconhecimento de voz. Use Chrome ou Edge.");
            }
        }, []);

        const toggleListening = useCallback((shouldListen) => {
            if (!recognitionRef.current) return;

            isListeningRef.current = shouldListen;
            setIsListening(shouldListen);

            if (shouldListen) {
            // Atraso para garantir que um stop() pendente tenha finalizado
            setTimeout(() => {
                if (isListeningRef.current) {
                try { recognitionRef.current.start(); } catch (e) {}
                }
            }, 150);
            } else {
            try { recognitionRef.current.stop(); } catch (e) {}
            }
        }, []);

        // --- LÓGICA DE PONTUAÇÃO AUTOMÁTICA (NLP SIMPLIFICADA) ---

        const calculateScore = (text, type) => {
            const normalizedText = text.toLowerCase().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
            const words = normalizedText.split(/\s+/);

            if (type === 'fluency') {
            const uniqueAnimals = new Set();
            words.forEach(w => {
                if (ANIMAL_KEYWORDS.includes(w)) uniqueAnimals.add(w);
            });
            return uniqueAnimals.size;
            } else {
            const foundTargets = new Set();
            words.forEach(w => {
                if (TARGET_WORDS.includes(w)) {
                let cleanWord = w;
                if(w === 'arvore') cleanWord = 'árvore';
                if(w === 'aviao') cleanWord = 'avião';
                foundTargets.add(cleanWord);
                }
            });
            return foundTargets.size;
            }
        };

        // --- NAVEGAÇÃO ENTRE FASES ---

        const nextPhase = useCallback(() => {
            toggleListening(false);
            lastSpokenText = '';

            switch (currentPhase) {
            case PHASES.WELCOME:
                setTranscript("");
                setCurrentPhase(PHASES.NAMING);
                break;
            case PHASES.NAMING:
                setScores(s => ({...s, naming: calculateScore(transcript, 'memory')}));
                setTranscript("");
                setCurrentPhase(PHASES.INCIDENTAL);
                break;
            case PHASES.INCIDENTAL:
                setScores(s => ({...s, incidental: calculateScore(transcript, 'memory')}));
                setTranscript("");
                setCurrentPhase(PHASES.IMMEDIATE);
                break;
            case PHASES.IMMEDIATE:
                setScores(s => ({...s, immediate: calculateScore(transcript, 'memory')}));
                setTranscript("");
                setCurrentPhase(PHASES.LEARNING);
                break;
            case PHASES.LEARNING:
                setScores(s => ({...s, learning: calculateScore(transcript, 'memory')}));
                setTranscript("");
                setCurrentPhase(PHASES.FLUENCY);
                break;
            case PHASES.FLUENCY:
                setScores(s => ({...s, fluency: calculateScore(transcript, 'fluency')}));
                setTranscript("");
                setCurrentPhase(PHASES.CLOCK);
                break;
            case PHASES.CLOCK:
                setTranscript("");
                setCurrentPhase(PHASES.DELAYED);
                break;
            case PHASES.DELAYED:
                setScores(s => ({...s, delayed: calculateScore(transcript, 'memory')}));
                setTranscript("");
                setCurrentPhase(PHASES.RECOGNITION);
                break;
            case PHASES.RECOGNITION:
                setScores(s => ({...s, recognition: calculateScore(transcript, 'memory')}));
                setTranscript("");
                setCurrentPhase(PHASES.REPORT);
                break;
            default: break;
            }
        }, [currentPhase, transcript, toggleListening]);

        const setClockScore = useCallback((score) => {
            setScores(s => ({...s, clock: score}));
        }, []);

        // --- RENDERIZAÇÃO CENTRAL ---

        return (
            <div className="min-h-screen bg-slate-100 p-4 font-sans text-slate-900">
            <header className="mb-6 flex justify-between items-center bg-white p-4 rounded-lg shadow-sm">
                <h1 className="text-xl font-bold text-blue-800 flex items-center gap-2">
                <Brain className="text-blue-600" /> BBRC Digital
                </h1>
                <div className="text-sm text-gray-500">Fase: {currentPhase.toUpperCase()}</div>
            </header>

            <main className="max-w-4xl mx-auto">

                {currentPhase === PHASES.WELCOME && (
                <div className="text-center bg-white p-8 rounded-xl shadow-lg">
                    <SpeechSynthesizer text="Bem vindo. Eu vou mostrar algumas figuras e fazer algumas perguntas. Por favor, certifique-se de que está em um local silencioso." />
                    <h2 className="text-2xl font-bold mb-4">Instruções</h2>
                    <p className="mb-6 text-gray-600">Este teste avaliará sua memória e atenção. O computador falará com você. Responda em voz alta e clara após o sinal.</p>
                    <button onClick={nextPhase} className="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold text-lg hover:bg-blue-700">Começar</button>
                </div>
                )}

                {currentPhase === PHASES.NAMING && (
                <MemoryPhase
                    title="Nomeação"
                    instruction="Que figuras são estas? Diga o nome de cada uma em voz alta."
                    showImage={true}
                    duration={0}
                    allowInputWithImage={true}
                    stimuliImage={images.stimuli}
                    isListening={isListening}
                    transcript={transcript}
                    toggleListening={toggleListening}
                    onNextPhase={nextPhase}
                />
                )}

                {currentPhase === PHASES.INCIDENTAL && (
                <MemoryPhase
                    title="Memória Incidental"
                    instruction="Agora, sem olhar, quais figuras eu acabei de lhe mostrar?"
                    showImage={false}
                    stimuliImage={images.stimuli}
                    isListening={isListening}
                    transcript={transcript}
                    toggleListening={toggleListening}
                    onNextPhase={nextPhase}
                />
                )}

                {currentPhase === PHASES.IMMEDIATE && (
                <MemoryPhase
                    title="Memória Imediata"
                    instruction="Olhe estas figuras novamente e tente decorá-las. Você tem 30 segundos."
                    showImage={true}
                    duration={30}
                    stimuliImage={images.stimuli}
                    isListening={isListening}
                    transcript={transcript}
                    toggleListening={toggleListening}
                    onNextPhase={nextPhase}
                />
                )}

                {currentPhase === PHASES.LEARNING && (
                <MemoryPhase
                    title="Aprendizado"
                    instruction="Vou mostrar mais uma vez por 30 segundos. Tente guardar todas na memória."
                    showImage={true}
                    duration={30}
                    stimuliImage={images.stimuli}
                    isListening={isListening}
                    transcript={transcript}
                    toggleListening={toggleListening}
                    onNextPhase={nextPhase}
                />
                )}

                {currentPhase === PHASES.FLUENCY && (
                <FluencyPhase
                    transcript={transcript}
                    toggleListening={toggleListening}
                    onNextPhase={nextPhase}
                />
                )}

                {currentPhase === PHASES.CLOCK && (
                <ClockPhase
                    onSetClockScore={setClockScore}
                    onNextPhase={nextPhase}
                />
                )}

                {currentPhase === PHASES.DELAYED && (
                <MemoryPhase
                    title="Memória Tardia"
                    instruction="Passou algum tempo. Que figuras eu mostrei para você no começo?"
                    showImage={false}
                    stimuliImage={images.stimuli}
                    isListening={isListening}
                    transcript={transcript}
                    toggleListening={toggleListening}
                    onNextPhase={nextPhase}
                />
                )}

                {currentPhase === PHASES.RECOGNITION && (
                <RecognitionPhase
                    recognitionImage={images.recognition}
                    isListening={isListening}
                    transcript={transcript}
                    toggleListening={toggleListening}
                    onNextPhase={nextPhase}
                />
                )}

                {currentPhase === PHASES.REPORT && (
                <ReportPhase
                    scores={scores}
                    educationLevel={educationLevel}
                    setEducationLevel={setEducationLevel}
                />
                )}

            </main>

            {/* Indicador de Status do Microfone Global */}
            <div className="fixed bottom-4 right-4 flex items-center gap-2 bg-white px-3 py-1 rounded-full shadow border text-xs no-print">
                {isListening ? (
                <>
                    <span className="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    <span className="text-red-600 font-bold">Microfone Ativo</span>
                </>
                ) : (
                <span className="text-gray-400">Microfone em espera</span>
                )}
            </div>
            </div>
        );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
